<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Enfusion Script API: Loadtime and Runtime</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript" src="darkmode_toggle.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Enfusion Script API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Loadtime and Runtime </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#WhatAreThese">What are these about</a><ul><li class="level2"><a href="#WhatAreThese_LoadtimeItems">Loadtime items</a></li>
<li class="level2"><a href="#WhatAreThese_RuntimeItems">Runtime items</a></li>
<li class="level2"><a href="#WhatAreThese_LocalItems">Local items</a></li>
</ul>
</li>
<li class="level1"><a href="#RplStateOverride">Replication state override</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="WhatAreThese"></a>
What are these about</h1>
<p>There are two main replication game states which replication distinguishes and which affect some characteristics of replicated items: loadtime state and runtime state. Items inserted into replication while game is loading (ie. at loadtime) are treated as loadtime items, while those inserted once the game is running (ie. at runtime) are treated as runtime items when inserted on server, or local items when inserted on client (as they only exist locally).</p>
<p>As always, for simplicity this page will use "items" to refer to both entities and components (and anything else that might be replicated).</p>
<h2><a class="anchor" id="WhatAreThese_LoadtimeItems"></a>
Loadtime items</h2>
<p>Loadtime items are generally entity instances placed in world. These are objects that shouldn't be moved around too much (though some degree of movement is allowed) and usually need to be visible from greater distances. Typical examples are buildings or street signs. Main things to keep in mind:</p><ul>
<li><b>They do not require prefab for spawning.</b></li>
<li><b>Their insertion must be deterministic on server and clients.</b> Server relies on clients to have the same initial world state after the map has been loaded. It can then replicate changes from this initial state as they become relevant for a given client, reducing overall traffic (by sending only changes) and spreading the load over time. Client will still be able to see things in the distance, even though their state has not been perfectly synchronized.<ul>
<li><a class="el" href="interfaceReplication.html" title="Main replication API.">Replication</a> validates that initial world state matches. That is, <a class="el" href="interfaceRplId.html" title="Replication item identifier.">RplId</a> and type information of each loadtime item is the same on client as was on server initially. When a mismatch is detected, "inconsistent item table" error will appear in log and client will be disconnected with JIP_ERROR.</li>
</ul>
</li>
<li><b>They may be out-of-sync with server for a long time</b> (possibly throughout whole play session). <a class="el" href="interfaceReplication.html" title="Main replication API.">Replication</a> scheduler running on server decides when to stream their current state to each client. When this decision is based on proximity, clients will only get current state streamed in when they get "close enough" for these changes to be relevant. Because of the world size, this may take a while or never happen at all.<ul>
<li>The only exception is complete removal of these items on server. In that case, removal will be replicated to clients unconditionally.</li>
</ul>
</li>
<li><b>As long as authority exists on server, proxy exists on client.</b><ul>
<li>Streaming in synchronizes state of proxy with authority. Once streamed in, proxy starts receiving state updates and it can send and receive RPCs.</li>
</ul>
</li>
</ul>
<dl class="section warning"><dt>Warning</dt><dd>Streaming out loadtime items while authority exists on server is currently considered undefined behavior. It should be avoided!</dd></dl>
<h2><a class="anchor" id="WhatAreThese_RuntimeItems"></a>
Runtime items</h2>
<p>Runtime items generally come from some game system that creates them during session. They can move around the map freely and they are usually not visible from far away. Typical examples are vehicles, player characters, collectible items. Main things to keep in mind:</p><ul>
<li><b>They require prefab for spawning.</b></li>
<li><b>They may only be inserted on server.</b> This is the authority.</li>
<li><b>Proxy may or may not exist on a client.</b><ul>
<li>Streaming in creates a proxy.</li>
<li>Streaming out destroys this proxy.</li>
<li>While proxy exists, it receives state updates and it can send and receive RPCs.</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="WhatAreThese_LocalItems"></a>
Local items</h2>
<p>Local items are items inserted on client during session. They can be used for locally predicted effects of player actions, such as firing from rocket launcher immediately creating a flying rocket on client who fired it, instead of waiting for server-side rocket to be streamed to this client. Main things to keep in mind:</p><ul>
<li><b>They do not require prefab for spawning.</b></li>
<li><b>They may only be inserted on client.</b> This is the authority.</li>
<li><b>There are no proxies on server or other clients.</b></li>
</ul>
<dl class="section note"><dt>Note</dt><dd>It is common to run same code on server and clients. This can sometimes lead to unintended insertion of local items on clients. In order to prevent accidents, Arma Reforger modifies prefab spawning in a way that (by default) only allows spawning prefabs on server.</dd></dl>
<h1><a class="anchor" id="RplStateOverride"></a>
Replication state override</h1>
<p>Replication state override (represented by RplStateOverride enum and configured using "Rpl State Override" property) is a property of <a class="el" href="interfaceRplComponent.html">RplComponent</a> that allows modifying the behavior of spawning and insertion process to behave as-if insertion of node hierarchy happened in specified state. Currently supported values are:</p><ul>
<li><b>None</b><ul>
<li>State for this node and its descendants at the time of insertion is inherited from parent node (on root of node hierarchy, it is current replication game state).</li>
</ul>
</li>
<li><b>Runtime</b><ul>
<li>State for this node and its descendants at the time of insertion is considered to be runtime.</li>
</ul>
</li>
</ul>
<p>In other words, as of right now it is only possible to change from loadtime to runtime state. This allows creation of complex prefabs that combine together both loadtime items and runtime items. As an example we can use prefab of a building with doors and windows (typical loadtime items) as well as food and weapons (typical runtime items) that player can pick up and carry around. To make this work, we set items meant to be carried around to use Runtime override. This will ensure that even if they were inserted while loading the map, they will be subject to rules for runtime items, rather than loadtime items. However, we have to make sure that none of the items meant to be loadtime items are descendants of those with Runtime override, otherwise the override will apply to them as well.</p>
<p>Notice also how state override applies to node and its descendants <b>at the time of insertion</b>. With entities and components, <b>child entities spawned during initialization must be attached to parent as part of spawning process</b>.</p>
<dl class="section warning"><dt>Warning</dt><dd>A common mistake is to spawn an entity first and then attach it as child of entity that spawned it. However, this results in spawned entity being inserted separately from parent. If this happens at loadtime and parent entity had state overridden to be runtime, child entity will not inherit state override (because it was not child at the time of insertion). It will instead be inserted as loadtime. Runtime entity spawning loadtime entity is currently considered undefined behavior because it violates requirement for deterministic insertion on server and client (runtime entities are not spawned on client, so they can't spawn loadtime children on client either) and should be avoided!</dd></dl>
<p>One could argue that overriding state should not be necessary, because correctly created map and systems for spawning dynamic objects like player and non-player characters, vehicles and items, will make sure that everything happens in correct game state. While that may be true, there may still be situations where these state overrides are useful:</p><ul>
<li><b>Simpler creation of map for testing.</b><ul>
<li>One doesn't have to configure complicated loot system just to have a car for testing in the map. Well made car prefab can just be dropped in the map and messed around with as if it were spawned by some loot system.</li>
</ul>
</li>
<li><b>Support for less dynamic map design.</b><ul>
<li>Games with relatively static level structure and carefully placed collectibles have no need for dynamic loot systems and all loot would be placed manually. Join-in-progress for coop mode in such games should just work when these items are correctly configured.</li>
</ul>
</li>
<li><b>Greater resilience against mistakes.</b><ul>
<li>We don't live in ideal world and mistakes happen. Sometimes, prefabs may be used in the map directly instead of being left up to dynamic spawning system. While that may seem like a small issue for designers who would be performing clean sweep later in the development cycle, it can potentially lead to various undefined behaviors once players interact with these items in multiplayer, causing crashes and stability problems which are much more serious (and harder to track down). Correctly configured prefab can stay misplaced without causing any issues. </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
